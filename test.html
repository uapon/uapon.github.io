<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sightings — UAPON</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
</head>
<body class="bg-slate-900 text-slate-100">

  <!-- (...) TU HTML EXISTENTE IGUAL IGUAL HASTA LA TABLA (...) -->

  <!-- Table -->
  <section class="container mx-auto py-12 px-6">
    <h2 class="text-2xl font-semibold mb-4">Sightings List</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full table-auto text-left">
        <thead>
          <tr class="bg-slate-800">
            <th class="px-4 py-2">Date</th>
            <th class="px-4 py-2">Location</th>
            <th class="px-4 py-2">Uploader</th>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="sightings-table">
          <!-- Aquí aparecerán dinámicamente las filas -->
          <tr>
            <td class="px-4 py-2 text-center text-slate-400" colspan="5">
              Cargando avistamientos…
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Footer y resto de tu HTML intactos -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    // Mobile Nav (tu código original)
    const btn = document.getElementById('nav-toggle');
    const menu = document.getElementById('nav-menu');
    btn.addEventListener('click', () => menu.classList.toggle('hidden'));

    // ----- INICIA INTEGRACIÓN DINÁMICA -----
    const API_URL   = "https://uapon.directus.app/items/sightings";
    const tableBody = document.getElementById("sightings-table");
    let map, markerLayerGroup;

    async function cargarAvistamientos() {
      try {
        // Fetch y validación de respuesta
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const { data } = await res.json();
        console.log("Datos recibidos:", data);

        // Limpiar tabla
        tableBody.innerHTML = "";

        // Limpiar solo los marcadores previos
        markerLayerGroup.clearLayers();

        // Si no hay datos, avisa
        if (!data.length) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5" class="px-4 py-2 text-center text-slate-400">
                No hay avistamientos.
              </td>
            </tr>`;
          return;
        }

        // Insertar filas y marcadores
        data.forEach(item => {
          // Fila en la tabla
          const tr = document.createElement("tr");
          tr.className = "bg-slate-700 hover:bg-slate-600";
          tr.innerHTML = `
            <td class="px-4 py-2">
              ${new Date(item.date_time).toLocaleDateString()}
            </td>
            <td class="px-4 py-2">
              ${item.latitude}, ${item.longitude}
            </td>
            <td class="px-4 py-2">Usuario</td>
            <td class="px-4 py-2">
              <span class="rounded px-2 py-1 text-xs ${
                item.status === "verified" ? "bg-green-600" :
                item.status === "pending"  ? "bg-yellow-500" :
                                             "bg-red-600"
              }">${item.status}</span>
            </td>
            <td class="px-4 py-2">
              <a href="#" class="text-blue-400 hover:underline">View</a>
            </td>`;
          tableBody.appendChild(tr);

          // Marcador en el mapa
          if (item.latitude && item.longitude) {
            const marker = L.marker([item.latitude, item.longitude])
              .bindPopup(`<b>${item.title}</b><br>${item.description}`);
            markerLayerGroup.addLayer(marker);
          }
        });
      } catch (err) {
        console.error("Error cargando avistamientos:", err);
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-2 text-red-400">
              Error cargando datos.
            </td>
          </tr>`;
      }
    }

    function initMap() {
      map = L.map("map").setView([4.6939, -74.0696], 3);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "© OpenStreetMap",
      }).addTo(map);

      // Creamos un grupo de capas para marcadores
      markerLayerGroup = L.layerGroup().addTo(map);
    }

    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      cargarAvistamientos();
      setInterval(cargarAvistamientos, 10000); // refrescar cada 10s
    });
    // ----- FIN INTEGRACIÓN DINÁMICA -----
  </script>

</body>
</html>
