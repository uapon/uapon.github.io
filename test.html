<!-- Sightings List & Map Responsive Section -->
<section class="container mx-auto py-12 px-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
  
  <!-- Sightings List -->
  <div class="space-y-4">
    <h2 class="text-2xl font-semibold mb-2">Sightings List</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full table-auto text-left border border-slate-700">
        <thead class="bg-slate-800 sticky top-0">
          <tr>
            <th class="px-4 py-2">Title</th>
            <th class="px-4 py-2">Description</th>
            <th class="px-4 py-2">Date</th>
            <th class="px-4 py-2">Location</th>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="sightings-table" class="divide-y divide-slate-700">
          <tr>
            <td colspan="6" class="px-4 py-4 text-center text-slate-400">
              Cargando avistamientos…
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Sightings Map -->
  <div class="space-y-4">
    <h2 class="text-2xl font-semibold mb-2">Sightings Map</h2>
    <div id="map" class="w-full h-80 rounded-lg bg-slate-700"></div>
  </div>

</section>

<!-- Leaflet + Script -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
  const API_URL = 
    "https://uapon.directus.app/items/sightings?" +
    "fields=id,title,description,date_time,latitude,longitude,status";

  let map, markersLayer;

  function initMap() {
    map = L.map("map").setView([4.6939, -74.0696], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap",
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  }

  async function reloadSightings() {
    try {
      const res = await fetch(API_URL);
      const { data } = await res.json();
      
      // clear table & markers
      const tbody = document.getElementById("sightings-table");
      tbody.innerHTML = "";
      markersLayer.clearLayers();

      if (!data.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-4 text-center text-slate-400">
              Sin avistamientos.
            </td>
          </tr>`;
        return;
      }

      // build table rows & markers
      data.forEach(item => {
        // table row
        const tr = document.createElement("tr");
        tr.className = "bg-slate-700 hover:bg-slate-600";
        tr.innerHTML = `
          <td class="px-4 py-2">${item.title}</td>
          <td class="px-4 py-2 truncate max-w-xs">${item.description}</td>
          <td class="px-4 py-2">${new Date(item.date_time).toLocaleDateString()}</td>
          <td class="px-4 py-2">${item.latitude}, ${item.longitude}</td>
          <td class="px-4 py-2">
            <span class="rounded px-2 py-1 text-xs ${
              item.status === "verified" ? "bg-green-600" :
              item.status === "pending"  ? "bg-yellow-500" :
                                           "bg-red-600"
            }">${item.status}</span>
          </td>
          <td class="px-4 py-2">
            <a 
              href="sighting.html?id=${item.id}" 
              class="text-blue-400 hover:underline"
            >View</a>
          </td>`;
        tbody.appendChild(tr);

        // map marker
        if (item.latitude && item.longitude) {
          const mk = L.marker([item.latitude, item.longitude])
            .bindPopup(`<strong>${item.title}</strong><br>${item.description}`);
          markersLayer.addLayer(mk);
        }
      });

      // fit map to markers
      const bounds = markersLayer.getBounds();
      if (bounds.isValid()) map.fitBounds(bounds, { padding: [20, 20] });

    } catch (err) {
      console.error("Error cargando avistamientos:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    initMap();
    reloadSightings();
    // refrescar cada 30 segundos
    setInterval(reloadSightings, 30000);
  });
</script>
