<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalle del Avistamiento — UAPON</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body class="bg-slate-900 text-slate-100">

  <!-- Aquí copias tu header idéntico al de test.html -->

  <main class="container mx-auto px-6 py-12">
    <div id="loading" class="text-center text-slate-400">Cargando detalle…</div>
    <div id="detail" class="hidden space-y-4">
      <h1 id="title" class="text-3xl font-bold"></h1>
      <p id="description" class="text-lg"></p>
      <ul class="space-y-2">
        <li><strong>Fecha:</strong> <span id="date"></span></li>
        <li><strong>Ubicación:</strong> <span id="loc"></span></li>
        <li><strong>Estado:</strong> <span id="status" class="px-2 py-1 rounded text-xs"></span></li>
        <li><strong>Registrado por:</strong> <span id="uploader"></span></li>
      </ul>
      <div id="map" class="h-80 rounded-lg bg-slate-700"></div>
    </div>
  </main>

  <!-- Copia tu footer también -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 1) Extraer el id de la URL
    const params = new URLSearchParams(window.location.search);
    const sightingId = params.get("id");

    if (!sightingId) {
      document.getElementById("loading").textContent = "ID de avistamiento no proporcionado.";
      throw new Error("No ID");
    }

    // 2) Petición a la API para un solo ítem
    const API_URL = `https://uapon.directus.app/items/sightings/${sightingId}?` +
      "fields=title,description,date_time,latitude,longitude,status," +
      "created_by.first_name,created_by.last_name";

    async function cargarDetalle() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const { data: item } = await res.json();

        // 3) Rellenar los elementos
        document.getElementById("title").textContent       = item.title;
        document.getElementById("description").textContent = item.description;
        document.getElementById("date").textContent        =
          new Date(item.date_time).toLocaleString("es-CO", {
            day: "numeric", month: "short", year: "numeric",
            hour: "2-digit", minute: "2-digit"
          });
        document.getElementById("loc").textContent         =
          `${item.latitude}, ${item.longitude}`;
        const statusEl = document.getElementById("status");
        statusEl.textContent = item.status;
        // ajustar color según estado
        statusEl.classList.add(
          item.status === "verified" ? "bg-green-600" :
          item.status === "pending"  ? "bg-yellow-500" :
                                       "bg-red-600"
        );
        const uploaderName = item.created_by
          ? `${item.created_by.first_name} ${item.created_by.last_name}`
          : "Usuario";
        document.getElementById("uploader").textContent = uploaderName;

        // 4) Mostrar sección y ocultar “loading”
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("detail").classList.remove("hidden");

        // 5) Iniciar mapa y marcador
        const map = L.map("map").setView([item.latitude, item.longitude], 6);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19, attribution: "© OpenStreetMap"
        }).addTo(map);
        L.marker([item.latitude, item.longitude])
          .addTo(map)
          .bindPopup(`<b>${item.title}</b><br>${item.description}`)
          .openPopup();

      } catch(err) {
        document.getElementById("loading").textContent =
          "Error cargando detalle: " + err.message;
        console.error(err);
      }
    }

    document.addEventListener("DOMContentLoaded", cargarDetalle);
  </script>
</body>
</html>
